let fetchController;self.addEventListener('fetch',a=>{if('audio'==a.request.destination){fetchController=new AbortController;let b=new Headers({'Icy-Metadata':'1'});const c=fetchController.signal;let d=new ReadableStream({start(e){function f(k){let l=+k.headers.get('icy-metaint'),m=k.body,n=m.getReader();return n.read().then(function o(p){if(!p.done){let q=p.value;for(let r=0;r<q.length;r++)if(g.push(q[r]),g.length>l+4080){let s=Uint8Array.from(g.splice(0,l)),t=16*g.shift();if(0<t){let u=h.decode(Uint8Array.from(g.splice(0,t)));self.clients.matchAll().then(function(v){v.forEach(function(w){w.postMessage({msg:u})})})}1==fetchController&&(e.close(),fetchController=0),e.enqueue(s)}return n.read().then(o)}})}let g=[],h=new TextDecoder,j=fetch(a.request.url,{signal:c,headers:b});j.then(k=>f(k)).then(()=>e.close())}});a.respondWith(new Response(d,{headers:{'Content-Type':'audio/mpeg'}}))}}),self.addEventListener('install',()=>{self.skipWaiting()}),self.addEventListener('activate',()=>{clients.claim()}),self.addEventListener('message',a=>{'https://example.com'!=a.origin||(fetchController=1)});
